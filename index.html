<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giro - Controle de Fluxo de Caixa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Container -->
    <div id="login-container" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Giro - Acesso Restrito</h2>
            <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden">Login ou senha inválidos.</div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Login</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden p-4 md:p-8 max-w-7xl mx-auto">
        <header class="mb-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">Controle de Fluxo de Caixa</h1>
                <p class="text-gray-600 mt-1">Gerencie as transações e saldos entre suas empresas.</p>
            </div>
            <button id="reset-all-btn" class="bg-red-600 text-white px-3 py-1 text-sm rounded-md hover:bg-red-700 transition self-start sm:self-center">
                ZERAR PAGAMENTOS
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Coluna da Esquerda: Cadastros e Lançamentos -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Cadastro de Empresas -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Cadastrar Empresas</h2>
                    <div class="flex gap-2">
                        <input type="text" id="company-name" placeholder="Nome da empresa" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="add-company-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">Adicionar</button>
                    </div>
                    <ul id="company-list" class="mt-4 space-y-2 text-sm">
                        <!-- Empresas serão listadas aqui -->
                    </ul>
                </div>

                <!-- Controle de Aportes -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. Registrar/Editar Aporte</h2>
                    <p class="text-sm text-gray-600 mb-4">Defina o valor total que cada empresa irá movimentar. O valor é salvo automaticamente ao sair do campo.</p>
                    <div id="contributions-container" class="space-y-3">
                         <!-- Formulários de aporte por empresa serão gerados aqui -->
                    </div>
                </div>

                <!-- Lançamento de Transação -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">3. Lançar Transação</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">De (Pagador)</label>
                            <select id="payer-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Para (Recebedor)</label>
                            <select id="receiver-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="text" inputmode="decimal" id="transaction-amount" placeholder="1.250,00" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nº da Nota Fiscal</label>
                            <input type="text" id="invoice-number" placeholder="Nº da NF" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Descrição</label>
                            <input type="text" id="transaction-description" placeholder="Breve descrição do pagamento" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="add-transaction-btn" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition">Registrar Pagamento</button>
                    </div>
                </div>
                
                 <!-- Retirada de Dinheiro -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">4. Retirada de Dinheiro (Saque)</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Sacar da Empresa:</label>
                            <select id="withdrawal-company-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Selecione --</option>
                            </select>
                        </div>
                        <div id="withdrawal-source-container" class="space-y-3 hidden">
                            <!-- Fontes de retirada serão geradas aqui -->
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Descrição do Saque</label>
                            <input type="text" id="withdrawal-description" placeholder="Ex: Adiantamento" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="add-withdrawal-btn" class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition hidden">Registrar Saque</button>
                    </div>
                </div>

                <!-- Ajuste Manual de Origem -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">5. Ajuste Manual de Origem</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ajustar Saldo da Empresa:</label>
                            <select id="adj-company-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Selecione a Empresa --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Origem do Capital a ser Ajustada:</label>
                            <select id="adj-origin-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" disabled>
                                <option value="">-- Selecione a Origem --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo de Ajuste:</label>
                            <select id="adj-type-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="add">Adicionar</option>
                                <option value="remove">Remover</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor do Ajuste (R$)</label>
                            <input type="text" inputmode="decimal" id="adj-amount-input" placeholder="500,00" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Motivo do Ajuste</label>
                            <input type="text" id="adj-description-input" placeholder="Ex: Correção de lançamento" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="add-adjustment-btn" class="w-full bg-orange-500 text-white py-2 rounded-md hover:bg-orange-600 transition">Registrar Ajuste</button>
                    </div>
                </div>


            </div>

            <!-- Coluna da Direita: Saldos e Histórico -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Saldo Consolidado -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Saldo Consolidado em Caixa</h2>
                    <div id="consolidated-balance" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <!-- Saldos serão exibidos aqui -->
                    </div>
                </div>

                <!-- Gráfico de Alocação de Capital -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Gráfico de Alocação de Capital</h2>
                    <p class="text-sm text-gray-600 mb-4">O gráfico mostra o capital original de cada empresa e onde ele está alocado atualmente.</p>
                    <div class="relative h-96">
                         <canvas id="allocationChartCanvas"></canvas>
                    </div>
                </div>

                <!-- Resumo de Saques por Origem -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Resumo de Saques por Origem</h2>
                    <p class="text-sm text-gray-600 mb-4">Total sacado de cada fonte de capital original em todas as empresas.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origem do Capital</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Sacado</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawal-summary-body" class="bg-white divide-y divide-gray-200">
                                <!-- Resumo dos saques será inserido aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Histórico de Transações -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Histórico de Transações</h2>
                    <!-- Filtros -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pagador</label>
                            <select id="filter-payer" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Recebedor</label>
                            <select id="filter-receiver" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Todas</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="filter-type" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Todos</option>
                                <option value="contribution">Aportes</option>
                                <option value="payment">Pagamentos</option>
                                <option value="withdrawal">Saques</option>
                                <option value="adjustment">Ajustes</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="filter-date" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">NF</label>
                             <input type="text" id="filter-invoice" placeholder="Buscar NF..." class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <button id="clear-filters-btn" class="w-full bg-gray-500 text-white py-2 rounded-md hover:bg-gray-600 transition">Limpar Filtros</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">De</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Para</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NF</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-history" class="bg-white divide-y divide-gray-200">
                                <!-- Histórico será inserido aqui -->
                            </tbody>
                             <tfoot id="transaction-history-footer" class="bg-gray-100 font-semibold">
                                <!-- Rodapé com total será inserido aqui -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão de Transação -->
    <div id="confirmation-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Confirmar Exclusão</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    Você tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.
                </p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="confirm-delete-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">
                    Excluir
                </button>
                <button id="cancel-delete-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Transação -->
    <div id="edit-transaction-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Editar Transação</h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">De (Pagador)</label>
                    <select id="edit-payer-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Para (Recebedor)</label>
                    <select id="edit-receiver-select" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="text" inputmode="decimal" id="edit-transaction-amount" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nº da Nota Fiscal</label>
                    <input type="text" id="edit-invoice-number" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="edit-transaction-description" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </form>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="save-edit-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:col-start-2 sm:text-sm">
                    Salvar Alterações
                </button>
                <button id="cancel-edit-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Reset Total -->
    <div id="reset-confirmation-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-medium leading-6 text-gray-900">⚠️ ATENÇÃO! Ação Irreversível</h3>
            <div class="mt-2">
                 <p class="text-sm text-gray-500">
                    Para zerar todos os dados, por favor, insira a senha mestre. Esta ação apagará todas as empresas, aportes e transações.
                </p>
                <div class="mt-4">
                    <label for="reset-password" class="block text-sm font-medium text-gray-700">Senha Mestre</label>
                    <input type="password" id="reset-password" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p id="reset-error" class="text-red-500 text-xs mt-1 hidden">Senha incorreta.</p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="confirm-reset-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">
                    Sim, Zerar Tudo
                </button>
                <button id="cancel-reset-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão de Empresa -->
    <div id="delete-company-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Excluir Empresa</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    Você tem certeza que deseja excluir a empresa <strong id="company-to-delete-name" class="text-gray-800"></strong>?
                </p>
                 <div class="mt-4">
                    <label for="delete-company-password" class="block text-sm font-medium text-gray-700">Senha Mestre</label>
                    <input type="password" id="delete-company-password" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p id="delete-company-error" class="text-red-500 text-xs mt-1 hidden">Senha incorreta.</p>
                </div>
                <p class="mt-2 text-sm text-red-600">
                    <strong>Atenção:</strong> Todas as transações e aportes associados a esta empresa serão permanentemente apagados.
                </p>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="confirm-delete-company-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">
                    Excluir Empresa
                </button>
                <button id="cancel-delete-company-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importa as funções necessárias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração do Firebase da sua aplicação web
        const firebaseConfig = {
            apiKey: "AIzaSyBcJmJfNlmx6-DpnQxTRtIP8icbxZYfD7Y",
            authDomain: "aplicativo-de-pagamento-giro.firebaseapp.com",
            projectId: "aplicativo-de-pagamento-giro",
            storageBucket: "aplicativo-de-pagamento-giro.appspot.com",
            messagingSenderId: "704183756257",
            appId: "1:704183756257:web:f911997f19f559d644dea0",
            measurementId: "G-D38DS4EY9V"
        };
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Estado da Aplicação ---
        let companies = [];
        let transactions = [];
        let transactionToDeleteId = null;
        let transactionToEditId = null;
        let companyToDelete = null;
        let allocationChart = null;


        // --- Elementos do DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const companyNameInput = document.getElementById('company-name');
        const addCompanyBtn = document.getElementById('add-company-btn');
        const companyList = document.getElementById('company-list');
        const payerSelect = document.getElementById('payer-select');
        const receiverSelect = document.getElementById('receiver-select');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const invoiceNumberInput = document.getElementById('invoice-number');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const consolidatedBalance = document.getElementById('consolidated-balance');
        const transactionHistory = document.getElementById('transaction-history');
        const transactionHistoryFooter = document.getElementById('transaction-history-footer');
        const contributionsContainer = document.getElementById('contributions-container');
        const filterPayer = document.getElementById('filter-payer');
        const filterReceiver = document.getElementById('filter-receiver');
        const filterInvoice = document.getElementById('filter-invoice');
        const filterDate = document.getElementById('filter-date');
        const filterType = document.getElementById('filter-type');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        
        // Modal de Exclusão de Transação
        const modal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        // Modal de Edição
        const editModal = document.getElementById('edit-transaction-modal');
        const editPayerSelect = document.getElementById('edit-payer-select');
        const editReceiverSelect = document.getElementById('edit-receiver-select');
        const editTransactionAmountInput = document.getElementById('edit-transaction-amount');
        const editInvoiceNumberInput = document.getElementById('edit-invoice-number');
        const editTransactionDescriptionInput = document.getElementById('edit-transaction-description');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        // Modal de Reset
        const resetModal = document.getElementById('reset-confirmation-modal');
        const resetPasswordInput = document.getElementById('reset-password');
        const resetError = document.getElementById('reset-error');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');

        // Modal Excluir Empresa
        const deleteCompanyModal = document.getElementById('delete-company-modal');
        const companyToDeleteNameEl = document.getElementById('company-to-delete-name');
        const deleteCompanyPasswordInput = document.getElementById('delete-company-password');
        const deleteCompanyError = document.getElementById('delete-company-error');
        const confirmDeleteCompanyBtn = document.getElementById('confirm-delete-company-btn');
        const cancelDeleteCompanyBtn = document.getElementById('cancel-delete-company-btn');

        // Painel de Retirada
        const withdrawalCompanySelect = document.getElementById('withdrawal-company-select');
        const withdrawalSourceContainer = document.getElementById('withdrawal-source-container');
        const withdrawalDescriptionInput = document.getElementById('withdrawal-description');
        const addWithdrawalBtn = document.getElementById('add-withdrawal-btn');

        // Resumo de Saques
        const withdrawalSummaryBody = document.getElementById('withdrawal-summary-body');

        // Painel de Ajuste
        const adjCompanySelect = document.getElementById('adj-company-select');
        const adjOriginSelect = document.getElementById('adj-origin-select');
        const adjTypeSelect = document.getElementById('adj-type-select');
        const adjAmountInput = document.getElementById('adj-amount-input');
        const adjDescriptionInput = document.getElementById('adj-description-input');
        const addAdjustmentBtn = document.getElementById('add-adjustment-btn');


        // --- Funções de Formatação ---
        const formatCurrency = (value) => {
            if (typeof value !== 'number') return '';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };
        
        const formatCurrencyInput = (input) => {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            input.value = value;
        };

        const unformatCurrency = (value) => {
            if (typeof value !== 'string' || value === '') return 0;
            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
        };
        
        
        // --- Lógica de Login ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'Luan' && password === 'Giro123') {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- Lógica Principal da Aplicação ---
        function initializeAppLogic() {
            onSnapshot(collection(db, 'companies'), (snapshot) => {
                companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                renderAll();
            });

            onSnapshot(collection(db, 'transactions'), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }
        
        // --- Funções de Renderização e Cálculo ---
        function renderAll() {
            const balances = calculateBalances();
            renderCompanyList();
            renderSelectOptions();
            renderContributions();
            renderConsolidatedBalance(balances);
            renderTransactionHistory();
            renderAllocationChart(balances);
            renderWithdrawalSummary();
            
            const currentWithdrawalCompany = withdrawalCompanySelect.value;
            withdrawalCompanySelect.innerHTML = '<option value="">-- Selecione --</option>' + companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            withdrawalCompanySelect.value = currentWithdrawalCompany;

            const currentAdjCompany = adjCompanySelect.value;
            adjCompanySelect.innerHTML = '<option value="">-- Selecione --</option>' + companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            adjCompanySelect.value = currentAdjCompany;
        }
        
        function calculateBalances() {
            const balances = {};
            companies.forEach(c => {
                balances[c.name] = { total: 0, from: {} };
            });

            const sortedTransactions = [...transactions].sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));
            
            sortedTransactions.forEach(t => {
                if (t.type === 'contribution') {
                    if (balances[t.receiver]) {
                        balances[t.receiver].total += t.amount;
                        balances[t.receiver].from[t.receiver] = (balances[t.receiver].from[t.receiver] || 0) + t.amount;
                    }
                } else if (t.type === 'withdrawal') {
                    if (balances[t.payer]) {
                        balances[t.payer].total -= t.amount;
                        if (t.sourceBreakdown) {
                            for (const [source, withdrawnAmount] of Object.entries(t.sourceBreakdown)) {
                                balances[t.payer].from[source] = (balances[t.payer].from[source] || 0) - withdrawnAmount;
                            }
                        }
                    }
                } else if (t.type === 'adjustment') {
                    if (balances[t.company]) {
                        balances[t.company].total += t.amount;
                        balances[t.company].from[t.origin] = (balances[t.company].from[t.origin] || 0) + t.amount;
                    }
                } else { // Regular payment
                    const payerName = t.payer;
                    const receiverName = t.receiver;
                    const amount = t.amount;

                    if (!balances[payerName] || !balances[receiverName]) return;

                    const payerBalance = balances[payerName];
                    const receiverBalance = balances[receiverName];
                    const payerTotalFrom = Object.values(payerBalance.from).reduce((sum, val) => sum + val, 0);

                    const transferBreakdown = {};
                    if (payerTotalFrom > 0) {
                        for (const [originCompany, originAmount] of Object.entries(payerBalance.from)) {
                            if (originAmount > 0) {
                                const proportion = originAmount / payerTotalFrom;
                                const transferAmountFromOrigin = amount * proportion;
                                transferBreakdown[originCompany] = (transferBreakdown[originCompany] || 0) + transferAmountFromOrigin;
                            }
                        }
                    } else {
                        // This case handles payments even if the 'from' breakdown is negative or zero, preventing crashes.
                        // It assumes the payment is valid and adjusts balances accordingly.
                        transferBreakdown[payerName] = (transferBreakdown[payerName] || 0) + amount;
                    }

                    for (const [originCompany, transferAmount] of Object.entries(transferBreakdown)) {
                        payerBalance.from[originCompany] = (payerBalance.from[originCompany] || 0) - transferAmount;
                        receiverBalance.from[originCompany] = (receiverBalance.from[originCompany] || 0) + transferAmount;
                    }

                    payerBalance.total -= amount;
                    receiverBalance.total += amount;
                }
            });
            return balances;
        }

        function renderCompanyList() {
            companyList.innerHTML = companies.length > 0 
                ? companies.map(c => `
                    <li class="bg-gray-100 p-2 rounded flex justify-between items-center">
                        <span>${c.name}</span>
                        <button data-id="${c.id}" data-name="${c.name}" class="delete-company-btn text-red-500 hover:text-red-700 p-1" title="Excluir empresa">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </li>
                `).join('')
                : '<li class="text-gray-500">Nenhuma empresa cadastrada.</li>';
        }

        function renderSelectOptions() {
            const optionsHTML = companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            payerSelect.innerHTML = optionsHTML;
            receiverSelect.innerHTML = optionsHTML;
            editPayerSelect.innerHTML = optionsHTML;
            editReceiverSelect.innerHTML = optionsHTML;
            filterPayer.innerHTML = '<option value="">Todas</option>' + optionsHTML;
            filterReceiver.innerHTML = '<option value="">Todas</option>' + optionsHTML;
        }

        function renderContributions() {
            contributionsContainer.innerHTML = companies.map(company => {
                const totalContribution = transactions
                    .filter(t => t.type === 'contribution' && t.receiver === company.name)
                    .reduce((sum, t) => sum + t.amount, 0);

                return `
                <div class="border-t pt-3">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">${company.name}</label>
                        <span class="text-sm text-gray-500">Aporte Atual: <strong>${formatCurrency(totalContribution)}</strong></span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" inputmode="decimal" data-company-input="${company.name}" placeholder="Adicionar valor" class="contribution-add-input flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <button data-company-btn="${company.name}" class="add-contribution-btn bg-indigo-500 text-white px-3 py-2 rounded-md hover:bg-indigo-600 transition text-sm">Adicionar</button>
                    </div>
                </div>
                `;
            }).join('');

            document.querySelectorAll('.contribution-add-input').forEach(input => {
                input.addEventListener('input', () => formatCurrencyInput(input));
            });
        }
        
        function renderConsolidatedBalance(balances) {
            consolidatedBalance.innerHTML = Object.entries(balances).map(([name, data]) => {
                const detailsId = `details-${name.replace(/\s+/g, '-')}`;
                const detailsHTML = Object.entries(data.from)
                    .filter(([_, value]) => Math.abs(value) > 0.001)
                    .map(([fromCompany, value]) => `
                        <li class="flex justify-between text-gray-600">
                            <span>Origem: ${fromCompany}</span>
                            <span class="${value >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(value)}</span>
                        </li>`)
                    .join('');

                return `
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-lg">${name}</span>
                            <span class="font-bold text-2xl ${data.total >= 0 ? 'text-green-700' : 'text-red-700'}">
                                ${formatCurrency(data.total)}
                            </span>
                        </div>
                        ${detailsHTML ? `
                        <div class="mt-4">
                           <button class="text-indigo-600 text-sm hover:underline" onclick="document.getElementById('${detailsId}').classList.toggle('hidden')">Ver Detalhes</button>
                           <ul id="${detailsId}" class="mt-2 space-y-1 text-sm hidden border-t pt-2">
                                ${detailsHTML}
                           </ul>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderTransactionHistory() {
            const payerFilter = filterPayer.value;
            const receiverFilter = filterReceiver.value;
            const invoiceFilter = filterInvoice.value.toLowerCase();
            const dateFilter = filterDate.value;
            const typeFilter = filterType.value;
            
            // Cria um mapa de ID para número sequencial para manter a numeração consistente
            const transactionNumbers = new Map();
            [...transactions]
                .sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0))
                .forEach((t, index) => transactionNumbers.set(t.id, index + 1));

            const filteredTransactions = transactions.filter(t => {
                const payerMatch = !payerFilter || t.payer === payerFilter || (t.type === 'adjustment' && t.company === payerFilter);
                const receiverMatch = !receiverFilter || t.receiver === receiverFilter;
                const invoiceMatch = !invoiceFilter || (t.invoice && t.invoice.toLowerCase().includes(invoiceFilter));
                const typeMatch = !typeFilter || (typeFilter === 'withdrawal' && t.type === 'withdrawal') || (typeFilter === 'payment' && (t.type === 'payment' || !t.type)) || (typeFilter === 'adjustment' && t.type === 'adjustment') || (typeFilter === 'contribution' && t.type === 'contribution');
                
                let dateMatch = true;
                if (dateFilter && t.timestamp && t.timestamp.toDate) {
                    const transactionDate = t.timestamp.toDate().toISOString().split('T')[0];
                    dateMatch = transactionDate === dateFilter;
                }
                
                return payerMatch && receiverMatch && invoiceMatch && dateMatch && typeMatch;
            }).sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); 

            transactionHistory.innerHTML = filteredTransactions.map((t) => {
                let payerCellHTML = t.payer || '---';
                let receiverCellHTML = t.receiver || '---';
                let amountColor = 'text-gray-900';
                let rowColor = '';

                if(t.type === 'contribution') {
                    rowColor = 'text-green-600';
                    amountColor = 'text-green-600';
                    payerCellHTML = 'Aporte de Capital';
                }
                else if(t.type === 'withdrawal'){
                    rowColor = 'text-red-600';
                    amountColor = 'text-red-600';
                    const sourceDetails = Object.keys(t.sourceBreakdown)
                        .map(source => `<span class="block text-xs text-gray-500">↳ Origem ${source}</span>`)
                        .join('');
                    payerCellHTML = `<div>${t.payer}${sourceDetails}</div>`;
                } else if (t.type === 'adjustment') {
                    amountColor = t.amount >= 0 ? 'text-blue-600' : 'text-orange-600';
                    payerCellHTML = `<div>${t.company}<span class="block text-xs text-gray-500">↳ Ajuste na Origem ${t.origin}</span></div>`;
                    receiverCellHTML = 'Ajuste Manual';
                }

                return `
                <tr class="text-sm ${rowColor}">
                    <td class="px-2 py-3 text-gray-500">${transactionNumbers.get(t.id)}</td>
                    <td class="px-4 py-3 text-gray-500">${formatTimestamp(t.timestamp)}</td>
                    <td class="px-4 py-3 align-top">${payerCellHTML}</td>
                    <td class="px-4 py-3 align-top">${receiverCellHTML}</td>
                    <td class="px-4 py-3 align-top font-medium ${amountColor}">${formatCurrency(t.amount)}</td>
                    <td class="px-4 py-3 align-top text-gray-500">${t.invoice || ''}</td>
                    <td class="px-4 py-3 align-top text-gray-500" title="${t.description || ''}">${(t.description || '').substring(0,30)}${(t.description || '').length > 30 ? '...' : ''}</td>
                    <td class="px-4 py-3 align-top">
                        <div class="flex items-center space-x-3">
                             ${t.type === 'payment' ? `
                            <button data-id="${t.id}" class="edit-transaction-btn text-indigo-600 hover:text-indigo-800" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            ` : ''}
                            <button data-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-800" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </td>
                </tr>
                `}).join('');

            const totalAmount = filteredTransactions.filter(t => (t.type === 'payment' || !t.type)).reduce((sum, t) => sum + t.amount, 0);
            const totalWithdrawals = filteredTransactions.filter(t => t.type === 'withdrawal').reduce((sum, t) => sum + t.amount, 0);

            transactionHistoryFooter.innerHTML = `
                <tr>
                    <td colspan="4" class="px-4 py-3 text-right">Total de Pagamentos:</td>
                    <td class="px-4 py-3">${formatCurrency(totalAmount)}</td>
                    <td colspan="3"></td>
                </tr>
                 <tr>
                    <td colspan="4" class="px-4 py-3 text-right text-red-600">Total de Saques:</td>
                    <td class="px-4 py-3 text-red-600">${formatCurrency(totalWithdrawals)}</td>
                    <td colspan="3"></td>
                </tr>
            `;
        }
        
        function calculateWithdrawalSummary() {
            const summary = {};
            const withdrawalTransactions = transactions.filter(t => t.type === 'withdrawal' && t.sourceBreakdown);

            for (const t of withdrawalTransactions) {
                for (const [source, amount] of Object.entries(t.sourceBreakdown)) {
                    if (!summary[source]) {
                        summary[source] = { total: 0, from: {} };
                    }
                    summary[source].total += amount;
                    summary[source].from[t.payer] = (summary[source].from[t.payer] || 0) + amount;
                }
            }
            return summary;
        }

        function renderWithdrawalSummary() {
            const summary = calculateWithdrawalSummary();
            if (Object.keys(summary).length === 0) {
                withdrawalSummaryBody.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-sm text-gray-500 text-center">Nenhum saque registrado.</td></tr>`;
                return;
            }

            withdrawalSummaryBody.innerHTML = Object.entries(summary)
                .sort((a, b) => b[1].total - a[1].total) // Sort by total amount
                .map(([source, data]) => {
                    const detailsHTML = Object.entries(data.from)
                        .map(([company, amount]) => `<span class="block text-xs text-gray-500">Sacado de ${company}: ${formatCurrency(amount)}</span>`)
                        .join('');

                    return `
                    <tr class="text-sm">
                        <td class="px-4 py-3 font-medium text-gray-800">${source}</td>
                        <td class="px-4 py-3 text-red-600 font-semibold">
                            <div>
                                <span>${formatCurrency(data.total)}</span>
                                ${detailsHTML}
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
        }


        function getChartColors(numColors) {
            const colors = [
                '#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#3B82F6',
                '#8B5CF6', '#EC4899', '#F97316', '#14B8A6', '#D946EF', '#06B6D4'
            ];
            return Array.from({ length: numColors }, (_, i) => colors[i % colors.length]);
        }

        function renderAllocationChart(balances) {
            const ctx = document.getElementById('allocationChartCanvas').getContext('2d');
            if (allocationChart) {
                allocationChart.destroy();
            }

            const contributionSources = [...new Set(transactions.filter(t => t.type === 'contribution').map(t => t.receiver))];
            
            if (contributionSources.length === 0) {
                 if (ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const labels = contributionSources;
            const locationCompanies = [...new Set(companies.map(c => c.name))];
            
            const colors = getChartColors(locationCompanies.length);
            const locationColorMap = new Map(locationCompanies.map((loc, i) => [loc, colors[i]]));
            
            const datasets = locationCompanies.map(location => {
                const data = labels.map(origin => {
                    const balance = balances[location]?.from?.[origin] || 0;
                    return balance > 0 ? balance : 0;
                });
                return {
                    label: `Alocado em ${location}`,
                    data: data,
                    backgroundColor: locationColorMap.get(location),
                };
            });
            
            allocationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição do Capital Aportado'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Capital Original (Aporte)'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Valor Alocado (R$)'
                            },
                             ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Manipuladores de Eventos ---
        addCompanyBtn.addEventListener('click', async () => {
            const name = companyNameInput.value.trim();
            if (name && !companies.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                await addDoc(collection(db, 'companies'), { name });
                companyNameInput.value = '';
            } else if (!name) {
                alert("O nome da empresa não pode estar vazio.");
            } else {
                alert("Essa empresa já foi cadastrada.");
            }
        });

        addTransactionBtn.addEventListener('click', async () => {
            const payer = payerSelect.value;
            const receiver = receiverSelect.value;
            const amount = unformatCurrency(transactionAmountInput.value);
            const invoice = invoiceNumberInput.value.trim();
            const description = transactionDescriptionInput.value.trim();

            if (!payer || !receiver || amount <= 0) {
                alert('Preencha os campos de Pagador, Recebedor e um Valor válido.');
                return;
            }
            if (payer === receiver) {
                alert('A empresa pagadora e a recebedora não podem ser a mesma.');
                return;
            }

            await addDoc(collection(db, 'transactions'), {
                type: 'payment',
                payer, receiver, amount, invoice, description, timestamp: new Date()
            });

            transactionAmountInput.value = '';
            invoiceNumberInput.value = '';
            transactionDescriptionInput.value = '';
        });
        
        transactionAmountInput.addEventListener('input', () => formatCurrencyInput(transactionAmountInput));
        editTransactionAmountInput.addEventListener('input', () => formatCurrencyInput(editTransactionAmountInput));


        filterPayer.addEventListener('change', renderTransactionHistory);
        filterReceiver.addEventListener('change', renderTransactionHistory);
        filterInvoice.addEventListener('input', renderTransactionHistory);
        filterDate.addEventListener('change', renderTransactionHistory);
        filterType.addEventListener('change', renderTransactionHistory);


        clearFiltersBtn.addEventListener('click', () => {
            filterPayer.value = '';
            filterReceiver.value = '';
            filterInvoice.value = '';
            filterDate.value = '';
            filterType.value = '';
            renderTransactionHistory();
        });
        
        document.body.addEventListener('click', async (e) => {
             const addContributionBtn = e.target.closest('.add-contribution-btn');
            if (addContributionBtn) {
                const companyName = addContributionBtn.dataset.companyBtn;
                const input = document.querySelector(`[data-company-input="${companyName}"]`);
                const amountToAdd = unformatCurrency(input.value);

                if (amountToAdd <= 0) {
                    alert("Por favor, insira um valor positivo para adicionar.");
                    return;
                }
                
                await addDoc(collection(db, 'transactions'), {
                    type: 'contribution',
                    receiver: companyName, // The company receiving the capital
                    amount: amountToAdd,
                    description: 'Aporte de capital',
                    timestamp: new Date()
                });

                input.value = '';
            }

            const deleteTransactionBtn = e.target.closest('.delete-transaction-btn');
            if (deleteTransactionBtn) {
                transactionToDeleteId = deleteTransactionBtn.dataset.id;
                modal.style.display = 'flex';
            }

            const editButton = e.target.closest('.edit-transaction-btn');
            if (editButton) {
                transactionToEditId = editButton.dataset.id;
                const transaction = transactions.find(t => t.id === transactionToEditId);
                if (transaction) {
                    editPayerSelect.value = transaction.payer;
                    editReceiverSelect.value = transaction.receiver;
                    editTransactionAmountInput.value = (transaction.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                    editInvoiceNumberInput.value = transaction.invoice;
                    editTransactionDescriptionInput.value = transaction.description;
                    editModal.style.display = 'flex';
                }
            }
            
            const deleteCompanyBtn = e.target.closest('.delete-company-btn');
            if(deleteCompanyBtn) {
                const id = deleteCompanyBtn.dataset.id;
                const name = deleteCompanyBtn.dataset.name;
                companyToDelete = { id, name };
                companyToDeleteNameEl.textContent = name;
                deleteCompanyPasswordInput.value = '';
                deleteCompanyError.classList.add('hidden');
                deleteCompanyModal.style.display = 'flex';
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            transactionToDeleteId = null;
            modal.style.display = 'none';
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!transactionToDeleteId) return;
            await deleteDoc(doc(db, "transactions", transactionToDeleteId));
            transactionToDeleteId = null;
            modal.style.display = 'none';
        });
        
        cancelEditBtn.addEventListener('click', () => {
            transactionToEditId = null;
            editModal.style.display = 'none';
        });

        saveEditBtn.addEventListener('click', async () => {
            if (!transactionToEditId) return;
            
            const payer = editPayerSelect.value;
            const receiver = editReceiverSelect.value;
            const amount = unformatCurrency(editTransactionAmountInput.value);
            const invoice = editInvoiceNumberInput.value.trim();
            const description = editTransactionDescriptionInput.value.trim();

             if (payer === receiver) {
                alert('A empresa pagadora e a recebedora não podem ser a mesma.');
                return;
            }

            const transactionRef = doc(db, "transactions", transactionToEditId);
            await updateDoc(transactionRef, {
                payer, receiver, amount, invoice, description
            });

            transactionToEditId = null;
            editModal.style.display = 'none';
        });
        
        // --- Eventos do Modal de Excluir Empresa ---
        cancelDeleteCompanyBtn.addEventListener('click', () => {
            companyToDelete = null;
            deleteCompanyModal.style.display = 'none';
        });

        confirmDeleteCompanyBtn.addEventListener('click', async () => {
            if (!companyToDelete) return;
            
            const password = deleteCompanyPasswordInput.value;
            if (password !== 'Pipueca') {
                deleteCompanyError.classList.remove('hidden');
                return;
            }

            deleteCompanyError.classList.add('hidden');
            const name = companyToDelete.name;

            const relatedTransactions = transactions.filter(t => t.payer === name || t.receiver === name);
            const transactionDeletions = relatedTransactions.map(t => deleteDoc(doc(db, "transactions", t.id)));
            await Promise.all(transactionDeletions);

            await deleteDoc(doc(db, "companies", companyToDelete.id));

            companyToDelete = null;
            deleteCompanyModal.style.display = 'none';
        });


        // --- Eventos do botão de Reset ---
        resetAllBtn.addEventListener('click', () => {
            resetPasswordInput.value = '';
            resetError.classList.add('hidden');
            resetModal.style.display = 'flex';
        });

        cancelResetBtn.addEventListener('click', () => {
            resetModal.style.display = 'none';
        });

        confirmResetBtn.addEventListener('click', async () => {
            const password = resetPasswordInput.value;
            if (password !== 'Pipueca') {
                resetError.classList.remove('hidden');
                return;
            }
            
            resetError.classList.add('hidden');
            const collectionsToDelete = ['transactions', 'companies'];
            
            for (const collName of collectionsToDelete) {
                const querySnapshot = await getDocs(collection(db, collName));
                for (const docSnapshot of querySnapshot.docs) {
                    await deleteDoc(doc(db, collName, docSnapshot.id));
                }
            }
            
            resetModal.style.display = 'none';
        });

        // --- Lógica do Painel de Retirada ---
        withdrawalCompanySelect.addEventListener('change', () => {
            const companyName = withdrawalCompanySelect.value;
            if(!companyName) {
                withdrawalSourceContainer.innerHTML = '';
                withdrawalSourceContainer.classList.add('hidden');
                addWithdrawalBtn.classList.add('hidden');
                return;
            }
            
            const balances = calculateBalances();
            const companyBalance = balances[companyName];
            const sources = companyBalance ? companyBalance.from : {};
            
            withdrawalSourceContainer.innerHTML = `<label class="block text-sm font-medium text-gray-700 mt-4 border-t pt-4">Especificar de qual fonte sacar:</label>`;
            
            let hasSources = false;
            for(const [sourceName, sourceAmount] of Object.entries(sources)) {
                if (sourceAmount > 0.01) {
                    hasSources = true;
                    withdrawalSourceContainer.innerHTML += `
                        <div class="flex items-center justify-between gap-2">
                            <label class="text-sm text-gray-600 w-1/3">De ${sourceName}:</label>
                            <input type="text" inputmode="decimal" data-source="${sourceName}" data-max="${sourceAmount}" placeholder="0,00" class="withdrawal-source-input w-2/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                        <p class="text-xs text-gray-500 text-right -mt-2">Disponível: ${formatCurrency(sourceAmount)}</p>
                    `;
                }
            }
            
            if(!hasSources) {
                withdrawalSourceContainer.innerHTML += `<p class="text-sm text-gray-500">Não há fundos disponíveis para saque nesta empresa.</p>`;
                addWithdrawalBtn.classList.add('hidden');
            } else {
                 addWithdrawalBtn.classList.remove('hidden');
                 document.querySelectorAll('.withdrawal-source-input').forEach(input => {
                    input.addEventListener('input', () => formatCurrencyInput(input));
                });
            }
            withdrawalSourceContainer.classList.remove('hidden');
        });

        addWithdrawalBtn.addEventListener('click', async () => {
            const companyName = withdrawalCompanySelect.value;
            if(!companyName) {
                alert('Selecione uma empresa para realizar o saque.');
                return;
            }
            
            const description = withdrawalDescriptionInput.value.trim();
            const sourceInputs = document.querySelectorAll('.withdrawal-source-input');
            let totalWithdrawal = 0;
            const sourceBreakdown = {};
            let hasError = false;

            sourceInputs.forEach(input => {
                const sourceName = input.dataset.source;
                const maxAmount = parseFloat(input.dataset.max);
                const amount = unformatCurrency(input.value);

                if(amount > 0) {
                    if (amount > maxAmount + 0.01) { // Add tolerance for floating point
                        alert(`O valor de saque da fonte ${sourceName} (${formatCurrency(amount)}) não pode exceder o valor disponível (${formatCurrency(maxAmount)}).`);
                        hasError = true;
                    }
                    totalWithdrawal += amount;
                    sourceBreakdown[sourceName] = amount;
                }
            });
            
            if(hasError) return;

            if(totalWithdrawal <= 0) {
                alert('Especifique um valor maior que zero para sacar.');
                return;
            }

            await addDoc(collection(db, 'transactions'), {
                type: 'withdrawal',
                payer: companyName,
                receiver: 'Saque',
                amount: totalWithdrawal,
                description: description,
                sourceBreakdown: sourceBreakdown,
                timestamp: new Date()
            });

            // Limpa o formulário
            withdrawalCompanySelect.value = '';
            withdrawalSourceContainer.innerHTML = '';
            withdrawalSourceContainer.classList.add('hidden');
            addWithdrawalBtn.classList.add('hidden');
            withdrawalDescriptionInput.value = '';
        });
        
        // --- Lógica do Painel de Ajuste ---
        adjCompanySelect.addEventListener('change', () => {
            const companyName = adjCompanySelect.value;
            adjOriginSelect.disabled = true;
            adjOriginSelect.innerHTML = '<option value="">-- Selecione a Origem --</option>';

            if (!companyName) return;

            const allOrigins = new Set(companies.map(c => c.name));
            const optionsHTML = [...allOrigins].map(origin => `<option value="${origin}">${origin}</option>`).join('');
            
            adjOriginSelect.innerHTML += optionsHTML;
            adjOriginSelect.disabled = false;
        });

        adjAmountInput.addEventListener('input', () => formatCurrencyInput(adjAmountInput));

        addAdjustmentBtn.addEventListener('click', async () => {
            const company = adjCompanySelect.value;
            const origin = adjOriginSelect.value;
            const type = adjTypeSelect.value;
            let amount = unformatCurrency(adjAmountInput.value);
            const description = adjDescriptionInput.value.trim();

            if (!company || !origin || amount <= 0) {
                alert("Preencha todos os campos para registrar o ajuste.");
                return;
            }

            if (type === 'remove') {
                amount = -amount;
            }

            await addDoc(collection(db, 'transactions'), {
                type: 'adjustment',
                company: company,
                origin: origin,
                amount: amount,
                description: description,
                timestamp: new Date()
            });

            adjCompanySelect.value = '';
            adjOriginSelect.innerHTML = '<option value="">-- Selecione a Origem --</option>';
            adjOriginSelect.disabled = true;
            adjAmountInput.value = '';
            adjDescriptionInput.value = '';
        });


    </script>
</body>
</html>

